{% extends "base.html" %}

{% block title %}ëŒ€í™” ì—…ë¡œë“œ{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto py-12">
    <div class="glass-panel p-8 rounded-2xl shadow-xl">
        <h2 class="text-2xl font-bold text-center text-slate-900 mb-2">ëŒ€í™” ë‚´ìš© ì—…ë¡œë“œ</h2>
        <p class="text-center text-slate-500 mb-8 text-sm">ì¹´ì¹´ì˜¤í†¡ ëŒ€í™” ë‚´ìš© ë‚´ë³´ë‚´ê¸°(.txt) íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</p>

        <form action="{{ url_for('upload_chat') }}" method="POST" enctype="multipart/form-data" class="space-y-6">

            <!-- Target Name Input -->
            <div>
                <label for="target_name" class="block text-sm font-medium text-slate-700">ë¶„ì„í•  ìƒëŒ€ë°© ëŒ€í™”ëª…</label>
                <div class="mt-1">
                    <input type="text" name="target_name" id="target_name" required
                        placeholder="ì˜ˆ: í™ê¸¸ë™ (ìƒëŒ€ë°©ì˜ ì¹´í†¡ ì´ë¦„ ì •í™•íˆ ì…ë ¥)"
                        class="block w-full px-3 py-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <p class="mt-1 text-xs text-slate-400">íŒŒì¼ ë‚´ì—ì„œ ì´ ì´ë¦„ìœ¼ë¡œ ëœ ë©”ì‹œì§€ë§Œ ì¶”ì¶œí•˜ì—¬ ë¶„ì„í•©ë‹ˆë‹¤.</p>
                </div>
            </div>

            <!-- File Input -->
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">ëŒ€í™” íŒŒì¼ (.txt) ë˜ëŠ” ê²°ê³¼ íŒŒì¼ (.json)</label>
                <div id="drop-zone"
                    class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-md hover:border-indigo-400 transition-colors bg-slate-50 cursor-pointer">
                    <div class="space-y-1 text-center pointer-events-none">
                        <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none"
                            viewBox="0 0 48 48" aria-hidden="true">
                            <path
                                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <div class="flex text-sm text-slate-600 justify-center">
                            <label for="file"
                                class="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500 pointer-events-auto">
                                <span>íŒŒì¼ ì„ íƒ</span>
                                <input id="file" name="file" type="file" class="sr-only" accept=".txt, .json" required>
                            </label>
                            <p class="pl-1">ë˜ëŠ” ë“œë˜ê·¸ ì•¤ ë“œë¡­</p>
                        </div>
                        <p class="text-xs text-slate-500">
                            TXT (ì¹´í†¡ ë‚´ë³´ë‚´ê¸°) ë˜ëŠ” JSON (ê²°ê³¼ íŒŒì¼)
                        </p>
                    </div>
                </div>
                <div id="file-error" class="mt-2 text-sm text-red-600 text-center font-medium hidden"></div>
                <div id="file-name-display" class="mt-2 text-sm text-indigo-600 text-center font-medium h-5"></div>
            </div>

            <div class="pt-4">
                <button type="submit" id="submit-btn" onclick="this.innerHTML='ì²˜ë¦¬ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”';"
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    ì—…ë¡œë“œ ë° ì‹œì‘
                </button>
            </div>
        </form>
    </div>
    <!-- Progress Overlay (Hidden by default) -->
    <div id="progress-overlay"
        class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center space-y-6">

            <!-- Spinner / Icon -->
            <div class="relative">
                <div class="animate-spin rounded-full h-16 w-16 border-4 border-indigo-100 border-t-indigo-600 mx-auto">
                </div>
                <!-- Optional: Center Icon -->
                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-2xl">
                    ğŸ§ 
                </div>
            </div>

            <!-- Titles -->
            <div>
                <h3 class="text-xl font-bold text-slate-900">ë¶„ì„ ì§„í–‰ ì¤‘...</h3>
                <p id="progress-status" class="text-indigo-600 font-medium text-sm mt-1 animate-pulse">ëŒ€í™” ë‚´ìš©ì„ ì½ê³  ìˆìŠµë‹ˆë‹¤...
                </p>
            </div>

            <!-- Timer -->
            <div class="text-4xl font-mono font-bold text-slate-700 tabular-nums">
                <span id="timer-min">00</span>:<span id="timer-sec">00</span>
            </div>

            <!-- Progress Bar -->
            <div class="relative pt-1">
                <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-indigo-100">
                    <div id="progress-bar" style="width: 0%"
                        class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-indigo-600 transition-all duration-300 ease-out">
                    </div>
                </div>
            </div>

            <p class="text-xs text-slate-400">
                ëŒ€í™” ì–‘ì— ë”°ë¼ 1~3ë¶„ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                í™”ë©´ì„ ë‹«ì§€ ë§ê³  ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
            </p>
        </div>
    </div>

</div>

<script>
    const fileInput = document.getElementById('file');
    const dropZone = document.getElementById('drop-zone');
    const fileNameDisplay = document.getElementById('file-name-display');
    const fileError = document.getElementById('file-error');
    const submitBtn = document.getElementById('submit-btn');
    const form = document.querySelector('form');

    // Progress Elements
    const progressOverlay = document.getElementById('progress-overlay');
    const progressBar = document.getElementById('progress-bar');
    const progressStatus = document.getElementById('progress-status');
    const timerMin = document.getElementById('timer-min');
    const timerSec = document.getElementById('timer-sec');

    // Make drop zone clickable
    dropZone.addEventListener('click', () => {
        fileInput.click();
    });

    fileInput.addEventListener('change', function (e) {
        validateAndDisplay(e.target.files[0]);
    });

    // Drag and Drop functionality
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropZone.classList.add('border-indigo-500', 'bg-indigo-50');
    }

    function unhighlight(e) {
        dropZone.classList.remove('border-indigo-500', 'bg-indigo-50');
    }

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files;
        validateAndDisplay(files[0]);
    }

    // Status Messages
    const messages = [
        "ëŒ€í™” íŒ¨í„´ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...",
        "ì£¼ìš” í‚¤ì›Œë“œë¥¼ ì¶”ì¶œ ì¤‘ì…ë‹ˆë‹¤...",
        "MBTI ì„±í–¥ì„ ì¶”ë¡ í•˜ê³  ìˆìŠµë‹ˆë‹¤...",
        "Big5 ì„±ê²© ìš”ì¸ì„ ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...",
        "ì†Œì‹œì˜¤ë‹‰ìŠ¤ ìœ í˜•ì„ ë§¤ì¹­í•˜ê³  ìˆìŠµë‹ˆë‹¤...",
        "ìµœì¢… ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤..."
    ];

    form.addEventListener('submit', function (e) {
        // Basic validation
        if (!fileInput.value) {
            e.preventDefault();
            fileError.textContent = "íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
            fileError.classList.remove('hidden');
            return;
        }

        // Show Overlay
        progressOverlay.classList.remove('hidden');

        // Start Timer
        let seconds = 0;
        setInterval(() => {
            seconds++;
            const m = Math.floor(seconds / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            timerMin.textContent = m;
            timerSec.textContent = s;
        }, 1000);

        // Start Simulated Progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            // Fast at first, then slower
            if (progress < 30) progress += 2;
            else if (progress < 60) progress += 0.5;
            else if (progress < 90) progress += 0.1;
            else progress += 0.05;

            // Never reach 100% until done
            if (progress > 95) progress = 95;

            progressBar.style.width = progress + "%";

            // Update messages based on progress
            const msgIndex = Math.floor((progress / 95) * messages.length);
            if (messages[msgIndex]) {
                progressStatus.textContent = messages[msgIndex];
            }
        }, 200);
    });

    function validateAndDisplay(file) {
        if (!file) {
            fileNameDisplay.textContent = "";
            fileError.classList.add('hidden');
            return;
        }

        const fileName = file.name;
        const ext = fileName.split('.').pop().toLowerCase();

        if (ext !== 'txt' && ext !== 'json') {
            fileError.textContent = "ì§€ì›ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. .txt ë˜ëŠ” .json íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
            fileError.classList.remove('hidden');
            fileNameDisplay.textContent = "";
            fileInput.value = ""; // Reset input
            return;
        }

        fileError.classList.add('hidden');
        fileNameDisplay.textContent = "ì„ íƒëœ íŒŒì¼: " + fileName;

        if (ext === 'json') {
            submitBtn.textContent = "ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸°";
            document.getElementById('target_name').required = false;
        } else {
            submitBtn.textContent = "ì—…ë¡œë“œ ë° ë¶„ì„ ì‹œì‘";
            document.getElementById('target_name').required = true;
        }
    }
</script>
{% endblock %}